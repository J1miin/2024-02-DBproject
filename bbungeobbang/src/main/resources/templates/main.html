<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Main</title>
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body>
<div class="flex">
  <div class="contents">
    <header>
      <!-- ë¡œê·¸ì¸ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥¸ ë‚´ìš© í‘œì‹œ -->
      <div th:if="${isLoggedIn}">
        <div class="fish_num">
          <p th:text="${nickname} + 'ë‹˜ì˜'"></p>
          <p th:text="'ë¶•ì–´ë¹µì´ ' + ${breadCount} + 'ê°œ êµ¬ì›Œì§€ê³  ìžˆì–´ìš”'"></p>
        </div>
        <div class="bell">
          <a th:href="@{/alarm/{userId}(userId=${userId})}">
            <img src="/images/bell.png" />
          </a>
        </div>
        <div class="forStyle">tets</div>
      </div>
      <div th:unless="${isLoggedIn}">
        <a th:href="@{/{userId}/letter/write(userId=${userId})}" class="write_btn">
          <img src="/images/write_btn.png" alt="Write Button" />
        </a>
        <p class="notlogin" th:text="${nickname} + 'ë‹˜ì—ê²Œ ë¶•ì–´ë¹µ ë‚¨ê¸°ê¸° ðŸŸðŸž'"></p>
      </div>
    </header>
    <main>
      <div class="shape"></div>
      <!-- ì—°ë„ë³„ ë¶•ì–´ë¹µ íŽ˜ì´ì§€ ì´ë™ ë²„íŠ¼ -->
      <div th:if="${isLoggedIn}">
        <a
                class="year_fish"
                th:href="@{/year/{userId}(userId=${userId})}"
                th:text="'ì—°ë„ ë³„ ê²¨ìš¸ ë¶•ì–´ë¹µ ë³´ëŸ¬ê°€ê¸°'"></a>

      </div>
    </main>
    <footer></footer>
  </div>
</div>
</body>
</html>
<script>
  const isLoggedIn = '[[${isLoggedIn}]]';
  const userId = '[[${userId}]]';
  document.addEventListener("DOMContentLoaded", () => {
    const fishGrid = document.querySelector(".shape");
    console.log(fishGrid)
    // ì„œë²„ì—ì„œ ë¶•ì–´ë¹µ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    function fetchFishStates() {
      fetch("/fishStates/"+userId)
              .then(response => response.json())
              .then(fishStates => {
                fishGrid.innerHTML = ""; // ê¸°ì¡´ ë¶•ì–´ë¹µë“¤ ì´ˆê¸°í™”
                fishStates.forEach((fish, index) => {
                  // ë¶•ì–´ ì´ë¯¸ì§€ì™€ ì •ë³´ë¥¼ ë‹´ì„ div ìƒì„±
                  const fishDiv = document.createElement("div");
                  fishDiv.classList.add("fish-item");

                  // ë¶•ì–´ë¹µ ì´ë¯¸ì§€ ì¶”ê°€
                  const img = document.createElement("img");
                  img.src = fish.isBaked ? "/images/bake.png" : "/images/nonbake.png";
                  img.alt = "ë¶•ì–´ë¹µ";
                  img.classList.add("fish");

                  // ë¶•ì–´ë¹µ ì•„ëž˜ì— ìž‘ì„±ìžëª…ê³¼ íƒ€ì´ë¨¸ ì¶”ê°€
                  const infoDiv = document.createElement("div");
                  infoDiv.classList.add("fish-info");

                  const writerName = document.createElement("p");
                  writerName.innerText = `ìž‘ì„±ìž: ${fish.writerName}`;
                  infoDiv.appendChild(writerName);

                  const timer = document.createElement("p");
                  const timerText = fish.isBaked
                          ? `ë‹¤ êµ¬ì›Œì¡Œì–´ìš”!`
                          : `${new Date(fish.unLockTimer).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}ì— ì—´ëžŒ ê°€ëŠ¥`;
                  timer.innerText = timerText;
                  timer.classList.add("timer"); // íƒ€ì´ë¨¸ì— í´ëž˜ìŠ¤ ì¶”ê°€
                  infoDiv.appendChild(timer);

                  // ë¶•ì–´ë¹µ ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸
                  img.addEventListener("click", () => {
                    if (fish.isBaked && isLoggedIn === "true") {
                      // ë¶•ì–´ë¹µ í´ë¦­ ì‹œ í•´ë‹¹ letterIdë¡œ íŽ˜ì´ì§€ ì´ë™
                      window.location.href = `/main/${userId}/read/${fish.letterId}`;
                    } else if (!fish.isBaked) {
                      alert("ì•„ì§ ë¶•ì–´ë¹µì´ ëœ ìµì—ˆì–´ìš”!");
                    } else {
                      alert("ë¡œê·¸ì¸ í›„ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤!");
                    }
                  });

                  // ìƒì„±ëœ ì´ë¯¸ì§€ì™€ ì •ë³´ divë¥¼ í•˜ë‚˜ì˜ divì— ì¶”ê°€
                  fishDiv.appendChild(img);
                  fishDiv.appendChild(infoDiv);

                  // ìœ„ì¹˜ ê³„ì‚°
                  const row = Math.floor(index / 3) + 1;
                  const col = (index % 3) + 1;
                  fishDiv.style.gridColumn = col;
                  fishDiv.style.gridRow = row;

                  fishGrid.appendChild(fishDiv);
                });
              })
              .catch(error => console.error("Error:", error));
    }

    fetchFishStates();
    setInterval(fetchFishStates, 60000); // 1ë¶„ë§ˆë‹¤ ê°±ì‹ 
  });
</script>

